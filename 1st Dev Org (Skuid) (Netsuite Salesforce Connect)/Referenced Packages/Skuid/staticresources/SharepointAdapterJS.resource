/*! Skuid Banzai 7.24.0 30-10-2015 */
!function(a){if(!a.adapter.get("Sharepoint")){var b=a.$,c=a.utils,d=c.makeXMLDoc,e=a.adapter.adapters,f=1,g=function(){return window.OData?b.Deferred().resolve().promise():c.loadJS("/resource/"+c.getCacheTimestamp()+"/skuid__ODataAdapterJS"+(a.dev?"Max":""))},h=function(a){return"SkuidSharepoint-"+a+"-Login-"},i=function(a){if(!a)return"Error";var b=a.body,c=d(b),e=c.children("m\\:code").first().text().split(","),f=e[1]&&e[1].trim&&e[1].trim();return f},j=function(a){if(a){var c=h(a.name);a.authentication.success=!1,b.removeCookie(c+"FedAuth"),b.removeCookie(c+"rtFa"),b.removeCookie(c+"Digest")}},k=function(a){var c=b.Deferred(),d=a.service,e=function(){var a=d.authentication;return"apex"===a.authMethod&&"Sharepoint_SharedLogin"===a.providerName},f=h(d.name),g=function(){return b.cookie(f+"FedAuth")&&b.cookie(f+"rtFa")&&b.cookie(f+"Digest")},i=function(){a.headers||(a.headers={}),b.cookie.raw=!0,a.headers.Cookie="FedAuth="+b.cookie(f+"FedAuth")+"; rtFa="+b.cookie(f+"rtFa")+";",a.headers["X-RequestDigest"]=b.cookie(f+"Digest"),b.cookie.raw=!1};return!d.isAuthenticated()&&e()&&g()&&(d.authentication.success=!0),d.authenticate().done(function(){d.isAuthenticated()&&e(d)&&i(d),c.resolve(a)}).fail(function(a){j(d),c.reject(a)}),c.promise()},l=function(a,c,d){d||(d={});var e=b.Deferred(),f=function(a){d.handleSuccess&&d.handleSuccess(a),e.resolve(a)},g=function(a){d.handleFail&&d.handleFail(a),e.reject(a)};return a().then(function(a){f(a)},function(d,e){var h=e&&e.length?e[0]:e||{};"System.UnauthorizedAccessException"===i(h)||-1!==b.inArray(h.statusCode,[401,403])?(j(c.service),k(c).then(function(){a().done(function(a){f(a)}).fail(function(a){g(a)})})):g(d)}),e.promise()};sharepoint={name:"Sharepoint",save:function(a,b){return g().then(function(){return k(b)}).then(function(b){var c=function(){return e["OData1-3"].save(a,b)};return l(c,b)})},load:function(a,c){return b.extend(c,{service:a[0].service}),g().then(function(){return k(c)}).then(function(c){var d=function(){return e["OData1-3"].load(a,b.extend({headers:{DataServiceVersion:"3.0"}},c))};return l(d,c)},function(a){return b.Deferred().reject(a).promise()})},getObjectList:function(a){return g().then(function(){return k(a)}).then(function(a){a||(a={}),b.extend(a,{entityContainer:"ListData"});var c=function(){return e["OData1-3"].getObjectList(a)};return l(c,a,{handleSuccess:function(a){a.push("SP.Files")}})})},buildEntityMetadataRequest:function(a){var b=a.targetEntity;return!b&&a.model&&a.model.attr&&(b=a.model.attr("sobject")),{objectName:b}},getEntityMetadataLoadingMessageFromBreadcrumb:function(a){return"Loading metadata for external object "+a.endsobject+"..."},getEntityMetadataCacheKey:function(a){return c.isString(a)?a:a.objectName},getEntityMetadata:function(a){return g().then(function(){return k(a)}).then(function(a){var b=function(){return e["OData1-3"].getEntityMetadata(a)};return l(b,a)})},isNewId:function(a){return"__skuidtemp"===a.substring(0,11)},getNewId:function(){return"__skuidtemp"+f++},getNameField:function(){return"ID"},properties:{canAutoGenerateConditionsFromFields:!0,validConditionTypes:["fieldvalue"],canConditionsBeGrouped:!0,composer:{canFieldsBeSelected:function(a){return a.breadcrumb.endsobject?!0:"Select a Sharepoint entity for this Model."},modelActionProps:function(c){var e,f=a.adapter.get("Sharepoint"),g=c.model,h=c.component,i=h.state,j=i.attr("functionname"),k=i.children("parameters"),l=function(a){var c=!1;k.length||(k=d("<parameters/>").appendTo(i),c=!0),b.each(a,function(){var a=this,b=k.children("[name="+a.name+"]");b.length||(b=d('<parameter name="'+a.name+'" type="'+a.type+'"/>').appendTo(k),c=!0)}),c===!0&&h.save()},m=[{id:"functionname",label:"Function",type:"autocomplete",displayTemplate:"{{name}}{{#parameter.0}} ({{#parameter}}{{type}}{{^last}}, {{/last}}{{/parameter}}){{/parameter.0}}",valueTemplates:{functionname:"{{name}}"},onChange:function(a,b){l(b.parameter),h.rebuildProps()},source:function(b,c){c(f.getServiceActions({objectName:g.attr("sobject"),metadata:a.service.getService(g.attr("service")).metadata,actionName:b.term}))}}];return j&&(e=f.getServiceActions({objectName:g.attr("sobject"),metadata:a.service.getService(g.attr("service")).metadata,actionName:j,parameters:k&&b.map(k.children(),function(a){var c=b(a);return{name:c.attr("name"),type:c.attr("type"),value:c.attr("value")}})})),e&&e.length&&(l(e[0].parameter),b.each(e[0].parameter,function(){var a=this,b=k.children("[name="+a.name+"]");m.push({label:a.name+" ("+a.type+")",type:"string",isStateless:!0,valueFunction:function(){return b.attr("value")},onChange:function(a){b.attr("value",a),h.save()}})})),m}}},getServiceActions:function(a){var c=a.model||{},d=a.actionName,f=a.parameters,g=a.objectName||c.objectName,h=a.metadata||c.service&&c.service.metadata,i=e["OData1-3"].processFullyQualifiedName(g),j=h.dataServices.schemaMap[i.nameSpace].entityContainerMap,k=j.ApiData,l=k.functionImport;if(d){var m=b.grep(l,function(a){return a.name===d});return f&&f.length&&(m=b.grep(m,function(c){var d=!0,e=c.isBindable!==!1,g=e===!0&&c.parameter[0]||{};return a.bindingType&&a.bindingType!==g.type&&(d=!1),g&&f[0].type!==g.type&&(d=!1),d===!0&&b.each(c.parameter,function(a,c){if(g&&0===a)return!0;var e=b.grep(f,function(a){return a.name===c.name&&a.type===c.type});return e.length?void 0:(d=!1,!1)}),d})),m}return l},runServiceAction:function(a){var d=a.context,e=d.model,f=d.row,h=a.parameters&&b.map(a.parameters.children(),function(a){var c=b(a);return{name:c.attr("name"),type:c.attr("type"),value:c.attr("value")}}),i={},j=e.service,l=j.serviceUrl,m=""+l,n={},o=this.getServiceActions({model:e,actionName:a.actionName,parameters:h});if(b.each(h,function(){i[this.name]=this}),!o.length)return!1;var p=o[0],q=p.parameter,r=p.isBindable!==!1&&q[0],s=q.slice(r?1:0);r&&(m+=c.mergeAsText(f?"row":"model",h[0].value,{},e,f)),m+="/"+p.name,s.length&&b.each(s,function(){var a=i[this.name];n[a.name]=c.mergeAsText(f?"row":"model",a.value,{},e,f)});var t=b.Deferred();return g().then(function(){return k({service:j})}).then(function(a){OData.request({requestUri:m,method:"POST",headers:b.extend({DataServiceVersion:"3.0"},a),data:n},function(a,b){t.resolve(a,b)},function(a){t.reject(a)})}),t.promise()}},new a.adapter.Adapter(sharepoint)}}(skuid);