/*! Skuid Banzai 7.24.0 30-10-2015 */
!function(a){var b=a.$,c=a.$M,d=a.$L,e=a.snippet,f=e.registerSnippet,g=a.utils,h=a.ui,i=h.fieldRenderers;f("Multipicklist",function(){i.MULTIPICKLIST.edit(arguments[0],g.decodeHTML(arguments[1]))}),f("skuid.snippets.utils.GetSObjectsAsItems",function(){var a=[],c=g.sObjectList;return c&&b.each(c,function(b,c){a.push({value:c,label:c})}),a}),f("skuid.pageAssignments.assignedTo",function(e,f){var h,i,j=c("Profiles"),k=e._GUID,l=e.id,m=e.model,n=e.row,o="skuid__Assigned_To_User__",p=o+"c",q=o+"r.Name",r=m.getField(p),s=m.getFieldValue(n,p,!0);if(f?g.startsWith(f,j.keyPrefix)?(h="profile",i=j.accessible&&j.dataMap[f]&&j.dataMap[f].Name):s&&(h="user",i=m.getFieldValue(n,q)):(i=d("Organization_Default"),h="org"),"edit"===e.mode&&j.accessible&&r.editable){var t=b("<select>");t.append(b("<option>").prop("selected","org"===h).attr("value","org").text(d("Organization_Default"))),t.append(b("<option>").prop("selected","profile"===h).attr("value","profile").text(d("Profile_Object_Label"))),t.append(b("<option>").prop("selected","user"===h).attr("value","user").text(r.referenceTo[0].label)),t.on("change",function(){var a=t.val(),b={};b[l]="",b[p]="",h=a,m.updateRow(n,b,{initiatorId:k}),"org"!==a&&a?"profile"===a?(v.show().val(""),x.hide()):"user"===a&&(v.hide(),x.show()):(v.hide(),x.hide())});var u=[];b.each(j.data,function(){var a={label:this.Name,value:this.Id};u.push(a)});var v=b("<input>").val(i).autocomplete({source:u,select:function(a,b){return m.updateRow(n,l,b.item.value,{initiatorId:k}),v.val(b.item.label),!1},minLength:0}).blur(function(){""===v.val()&&m.updateRow(n,l,"",{initiatorId:k})}),w=new a.ui.Field(n,m,null,{fieldId:p,useSOSL:!0,SOSLFields:"ALL FIELDS",searchFields:[{id:"Name"}],returnFields:[{id:"Name",showInSearchDialog:!0},{id:"Title",showInSearchDialog:!0},{id:"Profile.Name",label:"<label>"+j.label+"</label>",showInSearchDialog:!0},{id:"Username",showInSearchDialog:!0}],mode:"edit",register:!0});w.render(),m.registerField({id:p,row:n,handleChange:function(){s=f=m.getFieldValue(n,p,!0),m.updateRow(n,l,s,{initiatorId:k}),i=m.getFieldValue(n,q)}});var x=w.element;e.element.addClass("nx-polymorphic").append(t,v,x),"org"===h?(v.hide(),x.hide()):"profile"===h?x.hide():"user"===h&&v.hide()}else{var y=b("<div>").addClass("nx-fieldtext").html(i);e.element.removeClass("nx-polymorphic").html(y)}}),f("skuid.pageAssignments.pageLookup",function(a,c){var d=a.model.getFieldValue(a.row,"skuid__Use_Standard_Layouts__c");if((d||!c&&0!==c)&&(c=""),"edit"!==a.mode)a.element.removeClass("nx-polymorphic"),d?i.TEXT.read(a,"(Use Standard Layouts)"):i.REFERENCE.read(a,c);else{var e,f=b("<select>");i.REFERENCE.edit(a,c),e=a.element.children("input").first(),f.append(b("<option>").prop("selected",!d).attr("value","skuid").text("Skuid Page")),f.append(b("<option>").prop("selected",d).attr("value","standard").text("Use Standard Layouts")),f.on("change",function(){a.model.updateRow(a.row,a.id,"",{initiatorId:a._GUID}),d="skuid"!==f.val(),a.model.updateRow(a.row,"skuid__Use_Standard_Layouts__c",d,{initiatorId:a._GUID}),d?e.hide():e.show()}),a.element.addClass("nx-polymorphic").prepend(f),d&&e.hide()}}),f("skuid.pageAssignments.recordTypeLookup",function(e,f){var g,h,i,j=c("RecordTypes"),k=a.label.merge(d("Any_X"),j.label||""),l=function(){var a=e.row.skuid__SObject_Type__c;g=[],h={},b.each(j.data,function(b,c){if(c.SobjectType===a){var d={label:c.Name,value:c.DeveloperName};g.push(d),h[c.DeveloperName]=d}})};if(l(),f&&h[f]?f=h[f].label:(f=k,i="any"),"edit"===e.mode&&j.accessible){var m=b("<select>");m.append(b("<option>").prop("selected","any"===i).attr("value","any").text(k)),m.append(b("<option>").prop("selected","any"!==i).attr("value","specific").text(d("Specific_Record_Type"))),m.on("change",function(){e.model.updateRow(e.row,e.id,"",{initiatorId:e._GUID}),"any"!==m.val()&&m.val()?"specific"===m.val()&&(n.show(),n.val("")):n.hide()});var n=b("<input>").val(f).autocomplete({source:function(a,c){l(),c(b.ui.autocomplete.filter(g,a.term))},select:function(a,b){return e.model.updateRow(e.row,e.id,b.item.value,{initiatorId:e._GUID}),n.val(b.item.label),!1},minLength:0}).blur(function(){""===n.val()&&e.model.updateRow(e.row,e.id,"",{initiatorId:e._GUID})});e.element.addClass("nx-polymorphic").append(m,n),"any"===i&&n.hide()}else{var o=b("<div>").addClass("nx-fieldtext").html(f);e.element.removeClass("nx-polymorphic").append(o)}});var j;f("skuid.pageAssignments.sObjectTypeLookup",function(a,c){var d="objectType";if(j||(j=e.getSnippet("skuid.snippets.utils.GetSObjectsAsItems")()),c||0===c?-1==b.inArray(c,g.sObjectList)&&(d="arbitrary"):c="","edit"!==a.mode){var f=b("<div>").addClass("nx-fieldtext").html(c);a.element.removeClass("nx-polymorphic").append(f)}else{var h,i,k=b("<select>"),l=function(a){"arbitrary"===a?(h.hide(),i.show()):(h.show(),i.hide())};k.append(b("<option>").prop("selected","objectType"===d).attr("value","objectType").text("Object Type")),k.append(b("<option>").prop("selected","arbitrary"===d).attr("value","arbitrary").text("Other Situation")),k.on("change",function(){a.model.updateRow(a.row,a.id,"",{initiatorId:a._GUID}),h.val(""),i.val(""),l(k.val())}),h=b("<input>").val(g.decodeHTML(c)).autocomplete({source:j,select:function(b,c){return a.model.updateRow(a.row,a.id,c.item.value,{initiatorId:a._GUID}),h.val(c.item.label),!1},minLength:0}).blur(function(){""===h.val()&&a.model.updateRow(a.row,a.id,"",{initiatorId:a._GUID})}),i=b("<input>").val(g.decodeHTML(c)),g.delayInputCallback(i,function(b){a.model.updateRow(a.row,a.id,b,{initiatorId:a._GUID})}),a.element.addClass("nx-polymorphic").append(k,h,i),l(d)}}),f("skuid.pageAssignments.objectTypesMultipicklist",function(d){var e=c("assign__UniqueObjectTypesUsed").data;d.element.append(a.ui.renderers.MULTIPICKLIST.edit({entries:b.map(e,function(a){return{value:a.objectType,label:a.objectType}}),renderas:e.length<=10?"CHECKBOXES":"",selectedList:8,onChange:function(a){d.model.updateRow(d.row,d.id,a,{initiatorId:d._GUID})}}))}),f("skuid.pageAssignments.createDefaultRowsForPackaging",function(){c("assign__StaticResourceInfoForPackaging").createRow(),c("assign__PageAssignmentInfoForPackaging").createRow()}),f("ExportAllPageAssignments",function(){var c=200,e=a.model.initializeModel(new a.model.Model({fields:[{id:"skuid__SObject_Type__c"},{id:"skuid__Action_Type__c"},{id:"skuid__Context__c"},{id:"skuid__RecordTypeDeveloperName__c"},{id:"skuid__Page__c"},{id:"skuid__Page__r.Name"},{id:"skuid__Page__r.skuid__Module__c"},{id:"skuid__Page__r.skuid__UniqueId__c"},{id:"skuid__Use_Standard_Layouts__c"},{id:"skuid__IsActive__c"},{id:"OwnerId"}],data:[],id:"AllPageAssignmentsForExport",objectName:"skuid__Page_Assignment__c",orderByClause:"skuid__SObject_Type__c, skuid__Action_Type__c",doQuery:!0,recordsLimit:c,canRetrieveMoreRows:!0})),f=b("<div>").text(d("retrieving_data_for_export"));b.blockUI({message:f});var g=function(){e.exportData({useAPINamesForHeaders:!0}),f.text(a.label.merge(d("all_records_exported_to_csv"),e.data.length)),setTimeout(function(){b.unblockUI()},1500)},h=function(){e.canRetrieveMoreRows?e.loadAllRemainingRecords({stepCallback:function(b,c){f.text(a.label.merge(d("retrieving_records_a_to_b"),b,c))},finishCallback:function(){g()}}):g()};e.load(function(){h()})});var k=a.sfdc,l=k.api,m=l.SObject,n=l.query,o=l.escapeMetadataBody;f("existingPageAssignmentPackRenderer",function(a,d){var e=c("assign__StaticResourceInfoForPackaging"),f=e.getFirstRow(),g=b("<input>").attr({type:"radio",name:"existingPageAssignmentPack"}).addClass("nx-radio").val(d).on("change.skuid",function(){var b=a.model,c=a.row;e.updateRow(f,{Name:b.getFieldValue(c,"Name"),Description:b.getFieldValue(c,"Description")})});a.element.append(g)}),f("skuid.pageAssignments.pack",function(){var a=arguments[0],d=a.model,e=a.row,f=b("#PageAssignmentsTable").data("object").list.getSelectedItems(),g=a.packAll,h=c("assign__PageAssignmentInfoForPackaging"),i=h.getFirstRow(),j=c("assign__PageAssignmentsInStaticResources"),k=d&&d.getFieldValue(e,"Name"),l=d&&d.getFieldValue(e,"Description"),p=(b("input[name='tab-radio-PageAssignmentPackDetailsTabSet']"),"SELECT Id, Name, Description FROM StaticResource WHERE Name = '"+k+"'"),q="SELECT Id,Name,skuid__SObject_Type__c,skuid__Action_Type__c,skuid__Context__c,skuid__Assigned_To_User__c, skuid__Assigned_To_User__r.Name, skuid__RecordTypeDeveloperName__c,skuid__Page__c,skuid__Page__r.skuid__UniqueId__c, skuid__Page__r.Name,skuid__Page__r.skuid__Module__c,skuid__Use_Standard_Layouts__c, skuid__IsActive__c FROM skuid__Page_Assignment__c ";if(g){if(h&&i){var r=[];if("specific"===i.ObjectTypesPackaging){var s=h.getFieldValue(i,"skuid__SObject_Type__c",!0);s&&r.push("skuid__SObject_Type__c IN ('"+s.split(";").join("','")+"')")}var t=i.ProfilesPackaging;"org"===t?r.push("skuid__Context__c = null"):"organdprofile"===t&&r.push("(skuid__Context__c = null) OR (skuid__Context__c like '00e%')"),r.length&&(q+="WHERE ("+r.join(") AND (")+")")}}else{if(!f||!f.length)return void b.blockUI({message:"Please select at least one Page Assignment to package.",timeout:2500});q+="WHERE Id IN ('"+b.map(f,function(a){return a.row.Id}).join("','")+"')"}q+=" ORDER BY skuid__RecordTypeDeveloperName__c NULLS LAST, skuid__Context__c NULLS LAST, skuid__Use_Standard_Layouts__c DESC, skuid__Page__r.skuid__Module__c NULLS FIRST",b.blockUI({message:"Getting Page Assignment and StaticResource records..."});var u,v,w=n(p),x=n(q);b.when(x).then(function(a){v=a.records}),b.when(w).then(function(a){u=a.records}),b.when(w,x).then(function(){var a,c=b.Deferred();u.length>0?(a=new m("StaticResource",{Id:u[0].Id,CacheControl:"Private"}),c.resolve()):(b.blockUI({message:"Creating StaticResource..."}),a=new m("StaticResource",{Name:k,Description:l,Body:o(JSON.stringify([])),CacheControl:"Private"}),a.insert({success:function(){c.resolve()},error:function(a){c.reject({resourceName:k,errorMessage:a.responseJSON[0].message})}})),b.when(c).then(function(){b.blockUI({message:"Packaging Page Assignments into StaticResource..."}),a.Body=o(JSON.stringify(v)),a.ContentType="application/json",b.when(a.update()).then(function(){b.blockUI({message:'The "'+k+'" Page Assignments Pack was created/updated successfully!',timeout:3e3}),b(".ui-dialog-content").last().dialog("close"),h.cancel(),j.updateData()},function(a){b.blockUI({message:'There was an error creating the "'+k+'" Page Assignments Pack'+(a&&a.errorMessage?":\n\n"+a.errorMessage:"."),timeout:5e3})})},function(a){b.blockUI({message:'There was an error creating the "'+a.resourceName+'" Page Assignments Pack:\n\n'+a.errorMessage,timeout:5e3})})})}),f("skuid.pageAssignments.packAll",function(){var c=b.extend(arguments[0],{packAll:!0});a.snippet.getSnippet("skuid.pageAssignments.pack")(c)});var p;f("skuid.pageAssignments.unpack",function(){var c,d=(arguments[0],[]),e=b("#pageAssignmentSRSelect").find("input");return b.each(e,function(){var a=b(this),c=a.val();null!==c&&a.prop("checked")===!0&&d.push(c)}),d.length?(c=b.Deferred(),a.PageAssignment.RefreshFromPacks(JSON.stringify(d),function(a){var d=b.parseJSON(a);d&&(d.isSuccess?c.resolve():(d.errors&&d.errors.length&&(b.blockUI({message:d.errors[0],timeout:5e3}),c.reject()),p=d.recordFailures,c.reject()))},{escape:!1}),c.promise()):(b.blockUI({message:"Please select one or more Page Assignment Packs.",timeout:2500}),!1)}),f("skuid.pageAssignments.displayUnpackFailures",function(){if(!(p&&p.length>0))return!1;var a=c("assign__FailedAssignments"),d=[];b.each(p,function(){var a=this.record;b.extend(a,{Error:this.message}),d.push(a)}),a.adoptRows(d)}),f("skuid.pageAssignments.redrawFilters",function(){var a=b("#PageAssignmentsTable").data("object");a&&a.list&&a.list.makeFiltersBar()}),f("skuid.pageAssignments.bytesToKBs",function(){var a=arguments[0],c=arguments[1],d=0;b.isNumeric(c)&&(d=b.number(c/1e3,1)+" KB"),i.TEXT.read(a,d)})}(skuid);